# Footy Liveliness - Makefile
# Automates setup and running of the application

.PHONY: help install install-python install-node scrape scrape-upcoming update start-api start-frontend start stop status clean test check-ports kill-ports

# Default target - show help
help:
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë         Footy Liveliness - Automated Setup & Run              ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "Available commands:"
	@echo ""
	@echo "  make install          - Install all dependencies (Python + Node)"
	@echo "  make scrape           - Scrape all season fixtures from FotMob"
	@echo "  make scrape-upcoming  - Scrape only upcoming fixtures (faster)"
	@echo "  make update           - Re-scrape data and restart application"
	@echo "  make start            - Start both API and frontend"
	@echo "  make start-api        - Start Flask API only"
	@echo "  make start-frontend   - Start React frontend only"
	@echo "  make stop             - Stop all running processes"
	@echo "  make status           - Check application status"
	@echo "  make clean            - Clean up temporary files"
	@echo "  make kill-ports       - Kill processes on ports 5001 and 3000"
	@echo "  make test             - Test API endpoints"
	@echo "  make check-ports      - Check if ports are available"
	@echo ""
	@echo "Quick Start:"
	@echo "  1. make install       (one-time setup)"
	@echo "  2. make start         (starts everything)"
	@echo ""
	@echo "Or run everything in one command:"
	@echo "  make install && make start"
	@echo ""

# Install all dependencies
install: install-python install-node
	@echo "‚úÖ All dependencies installed!"
	@echo ""
	@echo "Next step: Run 'make start' to launch the application"

# Install Python dependencies
install-python:
	@echo "üì¶ Installing Python dependencies..."
	pip3 install flask flask-cors pandas numpy scikit-learn requests
	@echo "‚úÖ Python dependencies installed"

# Install Node dependencies
install-node:
	@echo "üì¶ Installing Node.js dependencies..."
	npm install
	@echo "‚úÖ Node.js dependencies installed"

# Scrape all season fixtures from FotMob (past + future)
scrape:
	@echo "üåê Scraping all season fixtures from FotMob (this may take a few minutes)..."
	python3 scrape_all_season_fixtures.py
	@echo "‚úÖ All fixtures scraped and saved"

# Scrape only upcoming fixtures (faster)
scrape-upcoming:
	@echo "üåê Scraping upcoming fixtures from FotMob..."
	python3 scrape_upcoming_fixtures.py
	@echo "‚úÖ Upcoming fixtures scraped and saved"

# Update: Re-scrape data and restart application
update:
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë              Updating Footy Liveliness Data                    ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üìä Step 1/3: Stopping application..."
	@$(MAKE) stop
	@echo ""
	@echo "üåê Step 2/3: Re-scraping fixtures from FotMob..."
	@$(MAKE) scrape
	@echo ""
	@echo "üöÄ Step 3/3: Restarting application with new data..."
	@$(MAKE) start
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë              ‚úÖ Update Complete!                               ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üì± Application running with latest data at http://localhost:3000"
	@echo "üîÑ New predictions loaded from updated fixtures"

# Check if ports are available
check-ports:
	@echo "üîç Checking if ports 5001 and 3000 are available..."
	@if lsof -Pi :5001 -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "‚ö†Ô∏è  Port 5001 is in use. Run 'make kill-ports' to free it."; \
	else \
		echo "‚úÖ Port 5001 is available"; \
	fi
	@if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "‚ö†Ô∏è  Port 3000 is in use. Run 'make kill-ports' to free it."; \
	else \
		echo "‚úÖ Port 3000 is available"; \
	fi

# Kill processes on ports 5001 and 3000
kill-ports:
	@echo "üî™ Killing processes on ports 5001 and 3000..."
	@-lsof -ti:5001 | xargs kill -9 2>/dev/null || echo "Port 5001 already free"
	@-lsof -ti:3000 | xargs kill -9 2>/dev/null || echo "Port 3000 already free"
	@echo "‚úÖ Ports freed"

# Start Flask API in background
start-api:
	@echo "üöÄ Starting Flask API on http://localhost:5001..."
	@python3 app.py &
	@sleep 3
	@echo "‚úÖ Flask API started"
	@echo "   Check: http://localhost:5001/api/health"

# Start React frontend in background
start-frontend:
	@echo "üöÄ Starting React frontend on http://localhost:3000..."
	@npm start &
	@sleep 5
	@echo "‚úÖ React frontend started"
	@echo "   Opening: http://localhost:3000"

# Start both API and frontend
start: kill-ports
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë              Starting Footy Liveliness Application            ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üöÄ Starting Flask API..."
	@python3 app.py > api.log 2>&1 & echo $$! > api.pid
	@sleep 3
	@if lsof -Pi :5001 -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "‚úÖ Flask API started on http://localhost:5001"; \
	else \
		echo "‚ùå Flask API failed to start. Check api.log for errors."; \
		exit 1; \
	fi
	@echo ""
	@echo "üöÄ Starting React frontend..."
	@BROWSER=none npm start > frontend.log 2>&1 & echo $$! > frontend.pid
	@sleep 8
	@if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "‚úÖ React frontend started on http://localhost:3000"; \
	else \
		echo "‚ùå React frontend failed to start. Check frontend.log for errors."; \
		exit 1; \
	fi
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë                    üéâ Application Ready!                       ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üì± Open your browser to: http://localhost:3000"
	@echo ""
	@echo "API Endpoints:"
	@echo "  ‚Ä¢ Health:    http://localhost:5001/api/health"
	@echo "  ‚Ä¢ Upcoming:  http://localhost:5001/api/upcoming"
	@echo "  ‚Ä¢ Stats:     http://localhost:5001/api/stats"
	@echo ""
	@echo "Logs:"
	@echo "  ‚Ä¢ API:       tail -f api.log"
	@echo "  ‚Ä¢ Frontend:  tail -f frontend.log"
	@echo ""
	@echo "To stop: make stop"
	@echo ""

# Stop all running processes
stop:
	@echo "üõë Stopping all processes..."
	@if [ -f api.pid ]; then \
		kill $$(cat api.pid) 2>/dev/null || true; \
		rm api.pid; \
		echo "‚úÖ Flask API stopped"; \
	fi
	@if [ -f frontend.pid ]; then \
		kill $$(cat frontend.pid) 2>/dev/null || true; \
		rm frontend.pid; \
		echo "‚úÖ React frontend stopped"; \
	fi
	@make kill-ports
	@echo "‚úÖ All processes stopped"

# Test API endpoints
test:
	@echo "üß™ Testing API endpoints..."
	@echo ""
	@echo "1. Health check:"
	@curl -s http://localhost:5001/api/health | python3 -m json.tool || echo "‚ùå API not responding"
	@echo ""
	@echo "2. Stats endpoint:"
	@curl -s http://localhost:5001/api/stats | python3 -m json.tool || echo "‚ùå Stats endpoint failed"
	@echo ""
	@echo "3. Upcoming matches (first 2):"
	@curl -s http://localhost:5001/api/upcoming | python3 -c "import sys, json; data = json.load(sys.stdin); print(json.dumps(data[:2], indent=2))" || echo "‚ùå Upcoming endpoint failed"
	@echo ""
	@echo "‚úÖ API tests complete"

# Clean up temporary files
clean:
	@echo "üßπ Cleaning up temporary files..."
	@rm -f api.log frontend.log api.pid frontend.pid
	@rm -rf __pycache__ .pytest_cache
	@find . -name "*.pyc" -delete
	@find . -name ".DS_Store" -delete
	@echo "‚úÖ Cleanup complete"

# Full reset - clean and reinstall
reset: clean
	@echo "üîÑ Performing full reset..."
	@rm -rf node_modules package-lock.json
	@echo "‚úÖ Reset complete. Run 'make install' to reinstall dependencies."

# Development mode - start with auto-reload
dev: kill-ports
	@echo "üîß Starting in development mode..."
	@echo ""
	@echo "Terminal 1: Flask API (with auto-reload)"
	@python3 app.py &
	@sleep 3
	@echo ""
	@echo "Terminal 2: React (with hot-reload)"
	@npm start

# Quick demo - install, scrape, and start
demo: install scrape start
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë                  üé¨ Demo Mode Ready!                           ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "The application is now running with live data!"
	@echo "Open http://localhost:3000 in your browser."
	@echo ""

# Show status of running processes
status:
	@echo "üìä Application Status:"
	@echo ""
	@if lsof -Pi :5001 -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "‚úÖ Flask API:      Running on port 5001"; \
	else \
		echo "‚ùå Flask API:      Not running"; \
	fi
	@if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "‚úÖ React Frontend: Running on port 3000"; \
	else \
		echo "‚ùå React Frontend: Not running"; \
	fi
	@echo ""
	@if [ -f ../data/current_season/upcoming_fixtures.json ]; then \
		FIXTURE_COUNT=$$(python3 -c "import json; print(len(json.load(open('../data/current_season/upcoming_fixtures.json'))))"); \
		echo "üìÖ Fixtures loaded: $$FIXTURE_COUNT matches"; \
	else \
		echo "‚ö†Ô∏è  No fixtures file found. Run 'make scrape' to fetch data."; \
	fi
	@echo ""

# Open application in browser
open:
	@echo "üåê Opening application in browser..."
	@open http://localhost:3000 || xdg-open http://localhost:3000 || echo "Please open http://localhost:3000 manually"

# Show logs
logs:
	@echo "üìú Application Logs:"
	@echo ""
	@echo "=== Flask API Log ==="
	@tail -20 api.log 2>/dev/null || echo "No API logs found"
	@echo ""
	@echo "=== React Frontend Log ==="
	@tail -20 frontend.log 2>/dev/null || echo "No frontend logs found"

# Watch logs in real-time
watch-logs:
	@echo "üëÄ Watching logs (Ctrl+C to stop)..."
	@tail -f api.log frontend.log

# Validate installation
validate:
	@echo "‚úÖ Validating installation..."
	@echo ""
	@echo "Python version:"
	@python3 --version
	@echo ""
	@echo "Node version:"
	@node --version
	@echo ""
	@echo "npm version:"
	@npm --version
	@echo ""
	@echo "Required Python packages:"
	@python3 -c "import flask; print('  ‚úÖ flask:', flask.__version__)"
	@python3 -c "import pandas; print('  ‚úÖ pandas:', pandas.__version__)"
	@python3 -c "import numpy; print('  ‚úÖ numpy:', numpy.__version__)"
	@python3 -c "import sklearn; print('  ‚úÖ scikit-learn:', sklearn.__version__)"
	@echo ""
	@echo "Model files:"
	@if [ -f model.pkl ]; then echo "  ‚úÖ model.pkl"; else echo "  ‚ùå model.pkl missing"; fi
	@if [ -f scaler.pkl ]; then echo "  ‚úÖ scaler.pkl"; else echo "  ‚ùå scaler.pkl missing"; fi
	@if [ -f team_stats.pkl ]; then echo "  ‚úÖ team_stats.pkl"; else echo "  ‚ùå team_stats.pkl missing"; fi
	@echo ""
	@echo "‚úÖ Validation complete"
